!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).bondage=t()}(this,(function(){"use strict";!function(){function e(e,t){var s;if(Object.defineProperty(this,"name",{enumerable:!1,writable:!1,value:"JisonParserError"}),null==e&&(e="???"),Object.defineProperty(this,"message",{enumerable:!1,writable:!0,value:e}),this.hash=t,t&&t.exception instanceof Error){var i=t.exception;this.message=i.message||e,s=i.stack}s||(Error.hasOwnProperty("captureStackTrace")?Error.captureStackTrace(this,this.constructor):s=new Error(e).stack),s&&Object.defineProperty(this,"stack",{enumerable:!1,writable:!1,value:s})}function t(e,t,s){s=s||0;for(var i=0;i<t;i++)this.push(e),e+=s}function s(e,t){for(t+=e=this.length-e;e<t;e++)this.push(this[e])}function i(e){for(var t=[],s=0,i=e.length;s<i;s++){var n=e[s];"function"==typeof n?(s++,n.apply(t,e[s])):t.push(n)}return t}"function"==typeof Object.setPrototypeOf?Object.setPrototypeOf(e.prototype,Error.prototype):e.prototype=Object.create(Error.prototype),e.prototype.constructor=e,e.prototype.name="JisonParserError";var n={trace:function(){},JisonParserError:e,yy:{},options:{type:"slr",errorRecoveryTokenDiscardCount:3},symbols_:{$accept:0,$end:1,"%prec":32,Add:36,AddAssign:22,And:41,BeginCommand:4,Comma:49,CommandCall:14,Dedent:13,Divide:39,DivideAssign:25,EOF:1,Else:8,ElseIf:9,EndCommand:6,EndIf:7,EndOfInput:3,EqualTo:43,EqualToOrAssign:21,False:27,GreaterThan:45,GreaterThanOrEqualTo:46,Identifier:18,If:5,Indent:12,LeftParen:34,LessThan:47,LessThanOrEqualTo:48,Minus:37,MinusAssign:23,Multiply:38,MultiplyAssign:24,Not:33,NotEqualTo:44,Null:30,Number:28,OptionDelimit:17,OptionEnd:16,OptionStart:15,Or:40,RightParen:35,Set:19,ShortcutOption:11,String:29,Text:10,True:26,UnaryMinus:31,Variable:20,Xor:42,additionalConditionalStatements:53,argument:63,arguments:62,assignment:59,command:56,conditionalStatement:52,error:2,expression:60,functionResultExpression:61,jump:57,link:58,node:50,shortcut:55,statement:54,statements:51},terminals_:{1:"EOF",2:"error",3:"EndOfInput",4:"BeginCommand",5:"If",6:"EndCommand",7:"EndIf",8:"Else",9:"ElseIf",10:"Text",11:"ShortcutOption",12:"Indent",13:"Dedent",14:"CommandCall",15:"OptionStart",16:"OptionEnd",17:"OptionDelimit",18:"Identifier",19:"Set",20:"Variable",21:"EqualToOrAssign",22:"AddAssign",23:"MinusAssign",24:"MultiplyAssign",25:"DivideAssign",26:"True",27:"False",28:"Number",29:"String",30:"Null",31:"UnaryMinus",32:"%prec",33:"Not",34:"LeftParen",35:"RightParen",36:"Add",37:"Minus",38:"Multiply",39:"Divide",40:"Or",41:"And",42:"Xor",43:"EqualTo",44:"NotEqualTo",45:"GreaterThan",46:"GreaterThanOrEqualTo",47:"LessThan",48:"LessThanOrEqualTo",49:"Comma"},TERROR:2,EOF:1,originalQuoteName:null,originalParseError:null,cleanupAfterParse:null,constructParseErrorInfo:null,yyMergeLocationInfo:null,__reentrant_call_depth:0,__error_infos:[],__error_recovery_infos:[],quoteName:function(e){return'"'+e+'"'},getSymbolName:function(e){if(this.terminals_[e])return this.terminals_[e];var t=this.symbols_;for(var s in t)if(t[s]===e)return s;return null},describeSymbol:function(e){if(e!==this.EOF&&this.terminal_descriptions_&&this.terminal_descriptions_[e])return this.terminal_descriptions_[e];if(e===this.EOF)return"end of input";var t=this.getSymbolName(e);return t?this.quoteName(t):null},collect_expected_token_set:function(e,t){var s=this.TERROR,i=[],n={};if(!t&&this.state_descriptions_&&this.state_descriptions_[e])return[this.state_descriptions_[e]];for(var r in this.table[e])if((r=+r)!==s){var o=t?r:this.describeSymbol(r);o&&!n[o]&&(i.push(o),n[o]=!0)}return i},productions_:function(e){for(var t=[],s=e.pop,i=e.rule,n=0,r=s.length;n<r;n++)t.push([s[n],i[n]]);return t}({pop:i([50,t,[51,4],52,52,t,[53,3],t,[54,6],55,t,[55,5,1],t,[59,4],t,[60,24],61,62,62,t,[63,3]]),rule:i([t,[2,3],1,1,8,6,7,8,6,t,[1,6],5,9,3,3,5,t,[6,5],t,[1,6],4,4,2,t,[3,14],1,4,3,t,[1,4]])}),performAction:function(e,t,s,i,n){var r=this.yy,o=r.parser;switch(r.lexer,t){case 0:
/*! Production::    $accept : node $end */
this.$=i[s-1],this._$=n[s-1];break;case 1:
/*! Production::    node : statements EndOfInput */return this.$=i[s-1],this._$=o.yyMergeLocationInfo(s-1,s),JSON.stringify(i[s-1],null,"  "),i[s-1];case 2:
/*! Production::    statements : statements conditionalStatement */case 3:
/*! Production::    statements : statements statement */
this._$=o.yyMergeLocationInfo(s-1,s),this.$=i[s-1].concat([i[s]]);break;case 4:
/*! Production::    statements : conditionalStatement */case 5:
/*! Production::    statements : statement */case 53:
/*! Production::    arguments : argument */
this._$=n[s],this.$=[i[s]];break;case 6:
/*! Production::    conditionalStatement : BeginCommand If expression EndCommand statements BeginCommand EndIf EndCommand */
this._$=o.yyMergeLocationInfo(s-7,s),this.$=new r.IfNode(i[s-5],i[s-3]);break;case 7:
/*! Production::    conditionalStatement : BeginCommand If expression EndCommand statements additionalConditionalStatements */
this._$=o.yyMergeLocationInfo(s-5,s),this.$=new r.IfElseNode(i[s-3],i[s-1],i[s]);break;case 8:
/*! Production::    additionalConditionalStatements : BeginCommand Else EndCommand statements BeginCommand EndIf EndCommand */
this._$=o.yyMergeLocationInfo(s-6,s),this.$=new r.ElseNode(i[s-3]);break;case 9:
/*! Production::    additionalConditionalStatements : BeginCommand ElseIf expression EndCommand statements BeginCommand EndIf EndCommand */
this._$=o.yyMergeLocationInfo(s-7,s),this.$=new r.ElseIfNode(i[s-5],i[s-3]);break;case 10:
/*! Production::    additionalConditionalStatements : BeginCommand ElseIf expression EndCommand statements additionalConditionalStatements */
this._$=o.yyMergeLocationInfo(s-5,s),this.$=new r.ElseIfNode(i[s-3],i[s-1],i[s]);break;case 11:
/*! Production::    statement : shortcut */case 12:
/*! Production::    statement : command */case 13:
/*! Production::    statement : jump */case 14:
/*! Production::    statement : link */case 15:
/*! Production::    statement : assignment */case 50:
/*! Production::    expression : functionResultExpression */
this._$=n[s],this.$=i[s];break;case 16:
/*! Production::    statement : Text */
this._$=n[s],this.$=new r.TextNode(i[s],this._$);break;case 17:
/*! Production::    shortcut : ShortcutOption Text Indent statements Dedent */
this._$=o.yyMergeLocationInfo(s-4,s),this.$=new r.DialogOptionNode(i[s-3],i[s-1],this._$);break;case 18:
/*! Production::    shortcut : ShortcutOption Text BeginCommand If expression EndCommand Indent statements Dedent */
this._$=o.yyMergeLocationInfo(s-8,s),this.$=new r.ConditionalDialogOptionNode(i[s-7],i[s-1],i[s-4],this._$);break;case 19:
/*! Production::    command : BeginCommand CommandCall EndCommand */
this._$=o.yyMergeLocationInfo(s-2,s),this.$=new r.CommandNode(i[s-1],this._$);break;case 20:
/*! Production::    jump : OptionStart Text OptionEnd */
this._$=o.yyMergeLocationInfo(s-2,s),this.$=new r.JumpNode(i[s-1],this._$);break;case 21:
/*! Production::    link : OptionStart Text OptionDelimit Identifier OptionEnd */
this._$=o.yyMergeLocationInfo(s-4,s),this.$=new r.LinkNode(i[s-3],i[s-1],this._$);break;case 22:
/*! Production::    assignment : BeginCommand Set Variable EqualToOrAssign expression EndCommand */
this._$=o.yyMergeLocationInfo(s-5,s),this.$=new r.SetVariableEqualToNode(i[s-3].substring(1),i[s-1]);break;case 23:
/*! Production::    assignment : BeginCommand Set Variable AddAssign expression EndCommand */
this._$=o.yyMergeLocationInfo(s-5,s),this.$=new r.SetVariableAddNode(i[s-3].substring(1),i[s-1]);break;case 24:
/*! Production::    assignment : BeginCommand Set Variable MinusAssign expression EndCommand */
this._$=o.yyMergeLocationInfo(s-5,s),this.$=new r.SetVariableMinusNode(i[s-3].substring(1),i[s-1]);break;case 25:
/*! Production::    assignment : BeginCommand Set Variable MultiplyAssign expression EndCommand */
this._$=o.yyMergeLocationInfo(s-5,s),this.$=new r.SetVariableMultipyNode(i[s-3].substring(1),i[s-1]);break;case 26:
/*! Production::    assignment : BeginCommand Set Variable DivideAssign expression EndCommand */
this._$=o.yyMergeLocationInfo(s-5,s),this.$=new r.SetVariableDivideNode(i[s-3].substring(1),i[s-1]);break;case 27:
/*! Production::    expression : True */case 28:
/*! Production::    expression : False */
this._$=n[s],this.$=new r.BooleanLiteralNode(i[s]);break;case 29:
/*! Production::    expression : Number */case 54:
/*! Production::    argument : Number */
this._$=n[s],this.$=new r.NumericLiteralNode(i[s]);break;case 30:
/*! Production::    expression : String */case 55:
/*! Production::    argument : String */
this._$=n[s],this.$=new r.StringLiteralNode(i[s]);break;case 31:
/*! Production::    expression : Null */
this._$=n[s],this.$=new r.NullLiteralNode(i[s]);break;case 32:
/*! Production::    expression : Variable */case 56:
/*! Production::    argument : Variable */
this._$=n[s],this.$=new r.VariableNode(i[s].substring(1));break;case 33:
/*! Production::    expression : UnaryMinus Number "%prec" UnaryMinus */
this._$=o.yyMergeLocationInfo(s-3,s),this.$=new r.UnaryMinusExpressionNode(i[s-2]);break;case 34:
/*! Production::    expression : UnaryMinus Variable "%prec" UnaryMinus */
this._$=o.yyMergeLocationInfo(s-3,s),this.$=new r.UnaryMinusExpressionNode(i[s-2].substring(1));break;case 35:
/*! Production::    expression : Not expression */
this._$=o.yyMergeLocationInfo(s-1,s),this.$=new r.NegatedBooleanExpressionNode(i[s]);break;case 36:
/*! Production::    expression : LeftParen expression RightParen */
this._$=o.yyMergeLocationInfo(s-2,s),this.$=new r.ArithmeticExpressionNode(i[s-1]);break;case 37:
/*! Production::    expression : expression Add expression */
this._$=o.yyMergeLocationInfo(s-2,s),this.$=new r.ArithmeticExpressionAddNode(i[s-2],i[s]);break;case 38:
/*! Production::    expression : expression Minus expression */
this._$=o.yyMergeLocationInfo(s-2,s),this.$=new r.ArithmeticExpressionMinusNode(i[s-2],i[s]);break;case 39:
/*! Production::    expression : expression Multiply expression */
this._$=o.yyMergeLocationInfo(s-2,s),this.$=new r.ArithmeticExpressionMultiplyNode(i[s-2],i[s]);break;case 40:
/*! Production::    expression : expression Divide expression */
this._$=o.yyMergeLocationInfo(s-2,s),this.$=new r.ArithmeticExpressionDivideNode(i[s-2],i[s]);break;case 41:
/*! Production::    expression : expression Or expression */
this._$=o.yyMergeLocationInfo(s-2,s),this.$=new r.BooleanOrExpressionNode(i[s-2],i[s]);break;case 42:
/*! Production::    expression : expression And expression */
this._$=o.yyMergeLocationInfo(s-2,s),this.$=new r.BooleanAndExpressionNode(i[s-2],i[s]);break;case 43:
/*! Production::    expression : expression Xor expression */
this._$=o.yyMergeLocationInfo(s-2,s),this.$=new r.BooleanXorExpressionNode(i[s-2],i[s]);break;case 44:
/*! Production::    expression : expression EqualTo expression */
this._$=o.yyMergeLocationInfo(s-2,s),this.$=new r.EqualToExpressionNode(i[s-2],i[s]);break;case 45:
/*! Production::    expression : expression NotEqualTo expression */
this._$=o.yyMergeLocationInfo(s-2,s),this.$=new r.NotEqualToExpressionNode(i[s-2],i[s]);break;case 46:
/*! Production::    expression : expression GreaterThan expression */
this._$=o.yyMergeLocationInfo(s-2,s),this.$=new r.GreaterThanExpressionNode(i[s-2],i[s]);break;case 47:
/*! Production::    expression : expression GreaterThanOrEqualTo expression */
this._$=o.yyMergeLocationInfo(s-2,s),this.$=new r.GreaterThanOrEqualToExpressionNode(i[s-2],i[s]);break;case 48:
/*! Production::    expression : expression LessThan expression */
this._$=o.yyMergeLocationInfo(s-2,s),this.$=new r.LessThanExpressionNode(i[s-2],i[s]);break;case 49:
/*! Production::    expression : expression LessThanOrEqualTo expression */
this._$=o.yyMergeLocationInfo(s-2,s),this.$=new r.LessThanOrEqualToExpressionNode(i[s-2],i[s]);break;case 51:
/*! Production::    functionResultExpression : Identifier LeftParen arguments RightParen */
this._$=o.yyMergeLocationInfo(s-3,s),this.$=new r.FunctionResultNode(i[s-3],i[s-1]);break;case 52:
/*! Production::    arguments : arguments Comma argument */
this._$=o.yyMergeLocationInfo(s-2,s),this.$=i[s-2].concat([i[s]])}},table:function(e){for(var t=[],s=e.len,i=e.symbol,n=e.type,r=e.state,o=e.mode,a=e.goto,l=0,h=s.length;l<h;l++){for(var d=s[l],u={},c=0;c<d;c++){var p=i.shift();switch(n.shift()){case 2:u[p]=[o.shift(),a.shift()];break;case 0:u[p]=r.shift();break;default:u[p]=[3]}}t.push(u)}return t}({len:i([12,1,12,0,0,3,t,[0,6],1,1,t,[0,3],12,1,1,2,2,14,t,[0,6],2,12,12,0,1,0,5,12,1,0,1,t,[12,14],s,[42,3],14,5,s,[12,8],12,15,15,0,0,t,[15,9],s,[27,3],2,t,[0,4],t,[14,5],0,14,0,6,t,[0,4],4,s,[96,7],s,[109,3],12,0,12,14,12,11,12,0,4,12,1,s,[27,3],1,0]),symbol:i([4,10,11,15,51,52,t,[54,6,1],1,3,s,[14,4],s,[13,7],5,14,19,10,10,18,20,t,[26,6,1],33,34,60,61,6,20,4,12,16,17,6,t,[36,13,1],20,28,s,[34,12],s,[12,12],34,t,[21,5,1],s,[94,12],5,18,s,[14,12],s,[56,24],s,[12,132],32,32,t,[35,14,1],20,28,29,62,63,s,[81,60],s,[249,3],13,s,[344,8],s,[24,12],16,s,[368,5],t,[53,7,1],6,s,[117,14],s,[15,150],31,31,35,49,s,[515,14],s,[14,70],5,7,8,9,14,19,s,[361,3],63,12,6,6,s,[315,15],s,[564,9],s,[12,12],s,[63,14],s,[353,12],s,[708,11],s,[639,13],7,14,19,s,[367,13],s,[115,6],6]),type:i([t,[2,4],t,[0,8],1,t,[2,5],t,[0,7],t,[2,15],s,[17,17],t,[2,17],s,[34,12],s,[12,14],s,[81,12],s,[14,14],s,[56,30],s,[12,130],s,[81,76],s,[249,24],s,[274,18],t,[2,252],s,[263,14],s,[278,6],s,[290,12],s,[302,27],s,[38,18],s,[49,20],s,[16,16]]),state:i([2,3,4,t,[6,5,1],15,16,s,[7,5],22,32,56,32,57,32,64,s,[21,7],67,s,[8,7],68,32,69,32,70,32,71,32,72,32,73,32,74,32,75,32,76,32,77,32,78,32,79,32,80,32,84,85,89,32,90,32,91,32,92,32,93,32,s,[67,7],95,32,15,98,s,[10,6],112,116,32,117,s,[66,7],118,s,[103,14],s,[7,7],122,s,[22,8],125,s,[16,6]]),mode:i([t,[1,301],t,[2,4],s,[6,6],t,[2,9],s,[15,13],s,[36,5],s,[45,10],s,[6,10],s,[15,11],s,[16,7],s,[15,9],s,[60,13],s,[15,68],t,[1,161]]),goto:i([5,t,[11,4,1],s,[5,4],t,[17,5,1],33,28,t,[23,5,1],29,30,31,34,35,37,36,t,[38,16,1],55,54,s,[32,10],s,[10,10],t,[58,6,1],s,[67,4],65,66,s,[6,4],s,[36,20],s,[10,110],81,82,83,s,[184,13],88,86,87,s,[69,50],s,[203,3],94,s,[204,11],96,97,s,[219,3],t,[37,4],43,44,t,[37,9],t,[38,4],43,44,t,[38,9],t,[41,3],s,[118,3],41,s,[118,8],42,42,s,[15,4],42,42,s,[15,7],43,43,s,[15,4],t,[43,3],s,[15,6],44,44,s,[15,4],t,[44,9],45,45,s,[178,5],t,[45,8],46,46,s,[15,4],t,[46,9],47,47,s,[15,4],t,[47,9],48,48,s,[15,4],t,[48,9],49,49,s,[15,4],t,[49,9],t,[99,5,1],s,[256,13],104,s,[14,13],105,s,[14,13],106,s,[14,13],107,s,[14,13],108,s,[14,13],17,109,110,111,18,19,s,[332,3],113,114,115,s,[295,13],13,s,[4,4],119,s,[44,13],s,[18,3],120,13,121,s,[27,7],17,123,18,19,124,s,[8,3],126,17,127,s,[66,4],128])}),defaultActions:function(e){for(var t={},s=e.idx,i=e.goto,n=0,r=s.length;n<r;n++){t[s[n]]=i[n]}return t}({idx:i([3,4,t,[6,6,1],14,15,16,t,[23,6,1],32,34,38,56,70,71,83,t,[85,4,1],94,96,t,[98,4,1],t,[103,5,1],112,114,120,125,126,128]),goto:i([4,5,t,[11,6,1],1,2,3,t,[27,6,1],50,19,20,35,39,40,36,t,[53,4,1],17,21,7,33,34,51,t,[22,5,1],52,6,18,10,8,9])}),parseError:function(e,t,s){if(!t.recoverable)throw"function"==typeof this.trace&&this.trace(e),s||(s=this.JisonParserError),new s(e,t);"function"==typeof this.trace&&this.trace(e),t.destroy()},parse:function(e){var t,s=this,i=new Array(128),n=new Array(128),r=new Array(128),o=new Array(128),a=this.table,l=0,h=0;this.TERROR;var d=this.EOF;this.options.errorRecoveryTokenDiscardCount;var u,c=[0,129];u=this.__lexer__?this.__lexer__:this.__lexer__=Object.create(this.lexer);var p={parseError:void 0,quoteName:void 0,lexer:void 0,parser:void 0,pre_parse:void 0,post_parse:void 0,pre_lex:void 0,post_lex:void 0};function y(e){if("object"==typeof e){var t={};for(var s in e)Object.prototype.hasOwnProperty.call(e,s)&&(t[s]=e[s]);return t}return e}function f(e,t){for(var s in t)void 0===e[s]&&Object.prototype.hasOwnProperty.call(t,s)&&(e[s]=t[s])}function x(e){var t=y(e);return t&&t.range&&(t.range=t.range.slice(0)),t}function E(){var e=u.fastLex();return"number"!=typeof e&&(e=s.symbols_[e]||e),e||d}"function"!=typeof assert||assert,this.yyGetSharedState=function(){return p},f(p,this.yy),p.lexer=u,p.parser=this,"function"==typeof p.parseError?this.parseError=function(e,t,s){return s||(s=this.JisonParserError),p.parseError.call(this,e,t,s)}:this.parseError=this.originalParseError,"function"==typeof p.quoteName?this.quoteName=function(e){return p.quoteName.call(this,e)}:this.quoteName=this.originalQuoteName,this.cleanupAfterParse=function(e,t,s){var a,h;t&&((p.post_parse||this.post_parse)&&(h=this.constructParseErrorInfo(null,null,null,!1)),p.post_parse&&void 0!==(a=p.post_parse.call(this,p,e,h))&&(e=a),this.post_parse&&void 0!==(a=this.post_parse.call(this,p,e,h))&&(e=a),h&&h.destroy&&h.destroy());if(this.__reentrant_call_depth>1)return e;if(u.cleanupAfterLex&&u.cleanupAfterLex(s),p&&(p.lexer=void 0,p.parser=void 0,u.yy===p&&(u.yy=void 0)),p=void 0,this.parseError=this.originalParseError,this.quoteName=this.originalQuoteName,i.length=0,n.length=0,o.length=0,r.length=0,l=0,!s){for(var d=this.__error_infos.length-1;d>=0;d--){var c=this.__error_infos[d];c&&"function"==typeof c.destroy&&c.destroy()}this.__error_infos.length=0}return e},this.yyMergeLocationInfo=function(e,t,s,i,n){var r,a=0|e,h=0|t,d=s,u=i;if(!d&&null!=e)for(var c=a;c<=h&&!(d=o[c]);c++);if(!u&&null!=t)for(c=h;c>=a&&!(u=o[c]);c--);if(!d&&null==e){if(!n)for(c=(a||l)-1;c>=0&&!(d=o[c]);c--);return d?((r=y(d)).first_line=r.last_line,r.first_column=r.last_column,r.range&&(r.range=r.range.slice(0),r.range[0]=r.range[1]),u&&(f(r,u),r.last_line=u.last_line,r.last_column=u.last_column,r.range&&u.range&&(r.range[1]=u.range[1])),r):u?((r=y(u)).range&&(r.range=r.range.slice(0)),r):void 0}if(d||(d=u,u=null),d)return(r=y(d)).range&&(r.range=r.range.slice(0)),u&&(f(r,u),r.last_line=u.last_line,r.last_column=u.last_column,r.range&&u.range&&(r.range[1]=u.range[1])),r},this.constructParseErrorInfo=function(e,t,s,a){var d={errStr:e,exception:t,text:u.match,value:u.yytext,token:this.describeSymbol(h)||h,token_id:h,line:u.yylineno,loc:x(u.yylloc),expected:s,recoverable:a,state:m,action:N,new_state:L,symbol_stack:i,state_stack:n,value_stack:r,location_stack:o,stack_pointer:l,yy:p,lexer:u,parser:this,destroy:function(){var e=!!this.recoverable;for(var t in this)this.hasOwnProperty(t)&&"object"==typeof t&&(this[t]=void 0);this.recoverable=e}};return this.__error_infos.push(d),d};var m,N,g,_,b,T,v,L,O=function(){var e=u.lex();return"number"!=typeof e&&(e=s.symbols_[e]||e),e||d},w={$:!0,_$:void 0,yy:p},I=!1;try{if(this.__reentrant_call_depth++,u.setInput(e,p),"function"==typeof u.canIUse)u.canIUse().fastLex&&(O=E);for(t=u.yylloc,o[l]=t,r[l]=null,n[l]=0,i[l]=0,++l,this.pre_parse&&this.pre_parse.call(this,p),p.pre_parse&&p.pre_parse.call(this,p),L=n[l-1];;){if(m=L,this.defaultActions[m])N=2,L=this.defaultActions[m];else if(h||(h=O()),_=a[m]&&a[m][h]||c,L=_[1],!(N=_[0])){var $,k=this.describeSymbol(h)||h,A=this.collect_expected_token_set(m);$="number"==typeof u.yylineno?"Parse error on line "+(u.yylineno+1)+": ":"Parse error: ","function"==typeof u.showPosition&&($+="\n"+u.showPosition(69,10)+"\n"),A.length?$+="Expecting "+A.join(", ")+", got unexpected "+k:$+="Unexpected "+k,b=this.constructParseErrorInfo($,null,A,!1),void 0!==(g=this.parseError(b.errStr,b,this.JisonParserError))&&(I=g);break}switch(N){default:if(N instanceof Array){b=this.constructParseErrorInfo("Parse Error: multiple actions possible at state: "+m+", token: "+h,null,null,!1),void 0!==(g=this.parseError(b.errStr,b,this.JisonParserError))&&(I=g);break}b=this.constructParseErrorInfo("Parsing halted. No viable error recovery approach available due to internal system failure.",null,null,!1),void 0!==(g=this.parseError(b.errStr,b,this.JisonParserError))&&(I=g);break;case 1:i[l]=h,r[l]=u.yytext,o[l]=x(u.yylloc),n[l]=L,++l,h=0,t=u.yylloc;continue;case 2:if(T=(v=this.productions_[L-1])[1],void 0!==(g=this.performAction.call(w,t,L,l-1,r,o))){I=g;break}l-=T;var M=v[0];i[l]=M,r[l]=w.$,o[l]=w._$,L=a[n[l-1]][M],n[l]=L,++l;continue;case 3:-2!==l&&(I=!0,l--,void 0!==r[l]&&(I=r[l]))}break}}catch(e){if(e instanceof this.JisonParserError)throw e;if(u&&"function"==typeof u.JisonLexerError&&e instanceof u.JisonLexerError)throw e;b=this.constructParseErrorInfo("Parsing aborted due to exception.",e,null,!1),I=!1,void 0!==(g=this.parseError(b.errStr,b,this.JisonParserError))&&(I=g)}finally{I=this.cleanupAfterParse(I,!0,!0),this.__reentrant_call_depth--}return I}};function r(){this.yy={}}n.originalParseError=n.parseError,n.originalQuoteName=n.quoteName,r.prototype=n,n.Parser=r,new r}();var e=Object.freeze({__proto__:null});var t={Whitespace:null,Indent:null,Dedent:null,EndOfLine:null,EndOfInput:null,UnaryMinus:null,Number:/-?[0-9]+(\.[0-9+])?/,String:/"([^"\\]*(?:\\.[^"\\]*)*)"/,BeginCommand:/<</,EndCommand:/>>/,Variable:/\$([A-Za-z0-9_.])+/,ShortcutOption:/->/,OptionStart:/\[\[/,OptionDelimit:/\|/,OptionEnd:/\]\]/,If:/if(?!\w)/,ElseIf:/elseif(?!\w)/,Else:/else(?!\w)/,EndIf:/endif(?!\w)/,Set:/set(?!\w)/,True:/true(?!\w)/,False:/false(?!\w)/,Null:/null(?!\w)/,LeftParen:/\(/,RightParen:/\)/,Comma:/,/,EqualTo:/(==|is(?!\w)|eq(?!\w))/,GreaterThan:/(>|gt(?!\w))/,GreaterThanOrEqualTo:/(>=|gte(?!\w))/,LessThan:/(<|lt(?!\w))/,LessThanOrEqualTo:/(<=|lte(?!\w))/,NotEqualTo:/(!=|neq(?!\w))/,Or:/(\|\||or(?!\w))/,And:/(&&|and(?!\w))/,Xor:/(\^|xor(?!\w))/,Not:/(!|not(?!\w))/,EqualToOrAssign:/(=|to(?!\w))/,Add:/\+/,Minus:/-/,Multiply:/\*/,Divide:/\//,AddAssign:/\+=/,MinusAssign:/-=/,MultiplyAssign:/\*=/,DivideAssign:/\/=/,Comment:"//",Identifier:/[a-zA-Z0-9_:.]+/,CommandCall:/([^>]|(?!>)[^>]+>)+(?=>>)/,Text:/.*/};var s=class{constructor(){this.transitions=[],this.textRule=null,this.isTrackingNextIndentation=!1}addTransition(e,s,i){return this.transitions.push({token:e,regex:t[e],state:s||null,delimitsText:i||!1}),this}addTextRule(e,t){if(this.textRule)throw new Error("Cannot add more than one text rule to a state.");const s=[];this.transitions.forEach((e=>{e.delimitsText&&s.push(`(${e.regex.source})`)}));const i=`((?!${s.join("|")}).)*`;return this.addTransition(e,t),this.textRule=this.transitions[this.transitions.length-1],this.textRule.regex=new RegExp(i),this}setTrackNextIndentation(e){return this.isTrackingNextIndentation=e,this}};var i={makeStates:function(){return{base:(new s).addTransition("BeginCommand","command",!0).addTransition("OptionStart","link",!0).addTransition("ShortcutOption","shortcutOption").addTextRule("Text"),shortcutOption:(new s).setTrackNextIndentation(!0).addTransition("BeginCommand","expression",!0).addTextRule("Text","base"),command:(new s).addTransition("If","expression").addTransition("Else").addTransition("ElseIf","expression").addTransition("EndIf").addTransition("Set","assignment").addTransition("EndCommand","base",!0).addTransition("CommandCall","commandOrExpression").addTextRule("Text"),commandOrExpression:(new s).addTransition("EndCommand","base",!0).addTextRule("Text"),assignment:(new s).addTransition("Variable").addTransition("EqualToOrAssign","expression").addTransition("AddAssign","expression").addTransition("MinusAssign","expression").addTransition("MultiplyAssign","expression").addTransition("DivideAssign","expression"),expression:(new s).addTransition("EndCommand","base").addTransition("Number").addTransition("String").addTransition("LeftParen").addTransition("RightParen").addTransition("EqualTo").addTransition("EqualToOrAssign").addTransition("NotEqualTo").addTransition("GreaterThanOrEqualTo").addTransition("GreaterThan").addTransition("LessThanOrEqualTo").addTransition("LessThan").addTransition("Add").addTransition("Minus").addTransition("Multiply").addTransition("Divide").addTransition("And").addTransition("Or").addTransition("Xor").addTransition("Not").addTransition("Variable").addTransition("Comma").addTransition("True").addTransition("False").addTransition("Null").addTransition("Identifier").addTextRule(),link:(new s).addTransition("OptionEnd","base",!0).addTransition("OptionDelimit","linkDestination",!0).addTextRule("Text"),linkDestination:(new s).addTransition("Identifier").addTransition("OptionEnd","base")}}};var n=class{constructor(){this.states=i.makeStates(),this.state="base",this.originalText="",this.lines=[],this.indentation=[[0,!1]],this.shouldTrackNextIndentation=!1,this.previousLevelOfIndentation=0,this.reset()}reset(){this.yytext="",this.yylloc={first_column:1,first_line:1,last_column:1,last_line:1},this.yylineno=1}lex(){if(this.isAtTheEndOfText()){this.yytext="";const e=this.indentation.pop();return e&&e[1]?"Dedent":"EndOfInput"}return this.isAtTheEndOfLine()?this.isAtTheEndOfText()?"Invalid":this.lexNextLine():this.lexNextTokenOnCurrentLine()}lexNextTokenOnCurrentLine(){const e=this.getCurrentLineIndentation();if(this.shouldTrackNextIndentation&&e>this.previousLevelOfIndentation)return this.indentation.push([e,!0]),this.shouldTrackNextIndentation=!1,this.yylloc.first_column=this.yylloc.last_column,this.yylloc.last_column+=e,this.yytext="","Indent";if(e<this.getLastRecordedIndentation()[0]){if(this.indentation.pop()[1])return this.yytext="",this.previousLevelOfIndentation=this.getLastRecordedIndentation()[0],"Dedent";this.lexNextTokenOnCurrentLine()}if(e===this.previousLevelOfIndentation&&1===this.yylloc.last_column&&(this.yylloc.last_column+=e),this.getCurrentLine().substring(this.yylloc.last_column-1).startsWith("//"))return this.lexNextLine();for(const t of this.getState().transitions){const s=this.getCurrentLine().substring(this.yylloc.last_column-1).match(t.regex);if(null===s||0!==s.index)continue;const i=s[0];this.yytext=this.getCurrentLine().substr(this.yylloc.last_column-1,i.length),"String"===t.token&&(this.yytext=this.yytext.substring(1,this.yytext.length-1).replace(/\\/g,"")),this.yylloc.first_column=this.yylloc.last_column,this.yylloc.last_column+=i.length,t.state&&(this.setState(t.state),this.shouldTrackNextIndentation&&this.getLastRecordedIndentation()[0]<e&&this.indentation.push([e,!1]));const n=this.getCurrentLine().substring(this.yylloc.last_column-1).match(/^\s*/);return 0!==n.length&&(this.yylloc.last_column+=n[0].length),t.token}return"Invalid"}lexNextLine(){this.yylineno+=1;const e=this.getCurrentLine().replace(/\t/,"    ");return this.lines[this.yylineno-1]=e,this.previousLevelOfIndentation=this.getLastRecordedIndentation()[0],this.yytext="",this.yylloc={first_column:1,first_line:this.yylineno,last_column:1,last_line:this.yylineno},this.lex()}setState(e){if(void 0===this.states[e])throw new Error(`Cannot set the unknown state [${e}]`);this.state=e,this.getState().isTrackingNextIndentation&&(this.shouldTrackNextIndentation=!0)}setInput(e){this.originalText=e.replace(/(\r\n)/g,"\n").replace(/\r/g,"\n").replace(/[\n\r]+$/,""),this.lines=this.originalText.split("\n"),this.reset()}getState(){return this.states[this.state]}getCurrentLine(){return this.lines[this.yylineno-1]}setCurrentLine(e){this.lines[this.yylineno-1]=e}getCurrentLineIndentation(){const e=this.getCurrentLine().match(/^(\s*)/g);return null===e&&null===e[0]?0:e[0].length}getLastRecordedIndentation(){return 0===this.indentation.length?[0,!1]:this.indentation[this.indentation.length-1]}isAtTheEndOfText(){return this.isAtTheEndOfLine()&&this.yylloc.first_line>=this.lines.length}isAtTheEndOfLine(){return this.yylloc.last_column>=this.getCurrentLine().length}};class r{}class o{}class a{}class l{}class h{}class d{}class u{}class c{}class p{}var y={types:{Text:r,Shortcut:o,Jump:a,Link:l,Conditional:h,Assignment:d,Literal:u,Expression:c,Command:p},RootNode:class{constructor(e){this.name="RootNode",this.dialogNodes=e||[]}},DialogNode:class{constructor(e,t){this.type="DialogNode",this.name=t||null,this.content=e}},DialogOptionNode:class extends o{constructor(e,t,s){super(),this.type="DialogOptionNode",this.text=e,this.content=t,this.lineNum=s?s.first_line:-1}},ConditionalDialogOptionNode:class extends o{constructor(e,t,s,i){super(),this.type="ConditionalDialogOptionNode",this.text=e,this.content=t,this.conditionalExpression=s,this.lineNum=i?i.first_line:-1}},IfNode:class extends h{constructor(e,t){super(),this.type="IfNode",this.expression=e,this.statement=t}},IfElseNode:class extends h{constructor(e,t,s){super(),this.type="IfElseNode",this.expression=e,this.statement=t,this.elseStatement=s}},ElseNode:class extends h{constructor(e){super(),this.type="ElseNode",this.statement=e}},ElseIfNode:class extends h{constructor(e,t,s){super(),this.type="ElseIfNode",this.expression=e,this.statement=t,this.elseStatement=s}},TextNode:class extends r{constructor(e,t){super(),this.type="TextNode",this.text=e,this.lineNum=t?t.first_line:-1}},JumpNode:class extends a{constructor(e,t){super(),this.type="JumpNode",this.identifier=e,this.lineNum=t?t.first_line:-1,this.selectable=!0}},LinkNode:class extends l{constructor(e,t,s){super(),this.type="LinkNode",this.text=e||null,this.identifier=t||this.text,this.lineNum=s?s.first_line:-1,this.selectable=!0}},NumericLiteralNode:class extends u{constructor(e){super(),this.type="NumericLiteralNode",this.numericLiteral=e}},StringLiteralNode:class extends u{constructor(e){super(),this.type="StringLiteralNode",this.stringLiteral=e}},BooleanLiteralNode:class extends u{constructor(e){super(),this.type="BooleanLiteralNode",this.booleanLiteral=e}},NullLiteralNode:class extends u{constructor(e){super(),this.type="NullLiteralNode",this.nullLiteral=e}},VariableNode:class extends u{constructor(e){super(),this.type="VariableNode",this.variableName=e}},UnaryMinusExpressionNode:class extends c{constructor(e){super(),this.type="UnaryMinusExpressionNode",this.expression=e}},ArithmeticExpressionNode:class extends c{constructor(e){super(),this.type="ArithmeticExpressionNode",this.expression=e}},ArithmeticExpressionAddNode:class extends c{constructor(e,t){super(),this.type="ArithmeticExpressionAddNode",this.expression1=e,this.expression2=t}},ArithmeticExpressionMinusNode:class extends c{constructor(e,t){super(),this.type="ArithmeticExpressionMinusNode",this.expression1=e,this.expression2=t}},ArithmeticExpressionMultiplyNode:class extends c{constructor(e,t){super(),this.type="ArithmeticExpressionMultiplyNode",this.expression1=e,this.expression2=t}},ArithmeticExpressionDivideNode:class{constructor(e,t){this.type="ArithmeticExpressionDivideNode",this.expression1=e,this.expression2=t}},BooleanExpressionNode:class extends c{constructor(e){super(),this.type="BooleanExpressionNode",this.booleanExpression=e}},NegatedBooleanExpressionNode:class extends c{constructor(e){super(),this.type="NegatedBooleanExpressionNode",this.booleanExpression=e}},BooleanOrExpressionNode:class extends c{constructor(e,t){super(),this.type="BooleanOrExpressionNode",this.expression1=e,this.expression2=t}},BooleanAndExpressionNode:class extends c{constructor(e,t){super(),this.type="BooleanAndExpressionNode",this.expression1=e,this.expression2=t}},BooleanXorExpressionNode:class extends c{constructor(e,t){super(),this.type="BooleanXorExpressionNode",this.expression1=e,this.expression2=t}},EqualToExpressionNode:class extends c{constructor(e,t){super(),this.type="EqualToExpressionNode",this.expression1=e,this.expression2=t}},NotEqualToExpressionNode:class extends c{constructor(e,t){super(),this.type="EqualToExpressionNode",this.expression1=e,this.expression2=t}},GreaterThanExpressionNode:class extends c{constructor(e,t){super(),this.type="GreaterThanExpressionNode",this.expression1=e,this.expression2=t}},GreaterThanOrEqualToExpressionNode:class extends c{constructor(e,t){super(),this.type="GreaterThanOrEqualToExpressionNode",this.expression1=e,this.expression2=t}},LessThanExpressionNode:class extends c{constructor(e,t){super(),this.type="LessThanExpressionNode",this.expression1=e,this.expression2=t}},LessThanOrEqualToExpressionNode:class extends c{constructor(e,t){super(),this.type="LessThanOrEqualToExpressionNode",this.expression1=e,this.expression2=t}},SetVariableEqualToNode:class extends d{constructor(e,t){super(),this.type="SetVariableEqualToNode",this.variableName=e,this.expression=t}},SetVariableAddNode:class extends d{constructor(e,t){super(),this.type="SetVariableAddNode",this.variableName=e,this.expression=t}},SetVariableMinusNode:class extends d{constructor(e,t){super(),this.type="SetVariableMinusNode",this.variableName=e,this.expression=t}},SetVariableMultipyNode:class extends d{constructor(e,t){super(),this.type="SetVariableMultipyNode",this.variableName=e,this.expression=t}},SetVariableDivideNode:class extends d{constructor(e,t){super(),this.type="SetVariableDivideNode",this.variableName=e,this.expression=t}},FunctionResultNode:class extends u{constructor(e,t){super(),this.type="FunctionResultNode",this.functionName=e,this.args=t}},CommandNode:class extends p{constructor(e,t){super(),this.type="CommandNode",this.command=e,this.lineNum=t?t.first_line:-1}}};class f{}var x={Result:f,TextResult:class extends f{constructor(e,t,s){super(),this.text=e,this.data=t,this.lineNum=s}},CommandResult:class extends f{constructor(e,t,s){super(),this.text=e,this.data=t,this.lineNum=s}},OptionsResult:class extends f{constructor(e,t){super(),this.options=e,this.lineNum=t,this.selected=-1}select(e){if(e<0||e>=this.options.length)throw new Error(`Cannot select option #${e}, there are only ${this.options.length} options`);this.selected=e}}};var E=class{constructor(){this.data={}}set(e,t){this.data[e]=t}get(e){return this.data[e]}};function m(e){if(e.__esModule)return e;var t=Object.defineProperty({},"__esModule",{value:!0});return Object.keys(e).forEach((function(s){var i=Object.getOwnPropertyDescriptor(e,s);Object.defineProperty(t,s,i.get?i:{enumerable:!0,get:function(){return e[s]}})})),t}const N=m(e).parser;N.lexer=new n,N.yy=y;const g=y.types;return{Runner:class{constructor(){this.yarnNodes={},this.variables=new E,this.functions={},this.visited={},this.registerFunction("visited",(e=>!!this.visited[e[0]]))}load(e){for(const t of e)this.yarnNodes[t.title]={title:t.title,tags:t.tags,body:t.body}}setVariableStorage(e){if("function"!=typeof e.set||"function"!=typeof e.get)throw new Error('Variable Storage object must contain both a "set" and "get" function');this.variables=e}registerFunction(e,t){if("function"!=typeof t)throw new Error("Registered function must be...well...a function");this.functions[e]=t}*run(e){const t=this.yarnNodes[e];if(void 0===t)throw new Error(`Node "${e}" does not exist`);this.visited[e]=!0;const s=Array.from(N.parse(t.body)),i={title:t.title,tags:t.tags.split(" "),body:t.body};yield*this.evalNodes(s,i)}*evalNodes(e,t){if(!e)return;let s=null,i=null,n=null;for(const r of e)if(r instanceof g.Jump)i=r;else if(null!==s&&r instanceof n)s.push(r);else if(null!==s&&(yield*this.handleSelections(s),s=null,n=null),r instanceof g.Text)yield new x.TextResult(r.text,t,r.lineNum);else if(r instanceof g.Link)n=g.Link,s=[r];else if(r instanceof g.Shortcut)n=g.Shortcut,s=[r];else if(r instanceof g.Assignment)this.evaluateAssignment(r);else if(r instanceof g.Conditional)yield*this.evalNodes(this.evaluateConditional(r),t);else if(r instanceof g.Command){if("stop"===r.command)return;yield new x.CommandResult(r.command,t,r.lineNum)}null!==i?yield*this.run(i.identifier):null!==s&&(yield*this.handleSelections(s))}*handleSelections(e){if(e.length>0||e[0]instanceof g.Shortcut){const t=e.filter((e=>"ConditionalDialogOptionNode"!==e.type||this.evaluateExpressionOrLiteral(e.conditionalExpression)));if(0===t.length)return;const s=new x.OptionsResult(t.map((e=>e.text)),t.map((e=>e.lineNum||-1)));if(yield s,-1!==s.selected){const e=t[s.selected];e.content?yield*this.evalNodes(e.content):e.identifier&&(yield*this.run(e.identifier))}}else yield*this.run(e[0].identifier)}evaluateAssignment(e){let t=this.evaluateExpressionOrLiteral(e.expression);const s=this.variables.get(e.variableName);if("SetVariableAddNode"===e.type)t+=s;else if("SetVariableMinusNode"===e.type)t-=s;else if("SetVariableMultiplyNode"===e.type)t*=s;else if("SetVariableDivideNode"===e.type)t/=s;else if("SetVariableEqualToNode"!==e.type)throw new Error(`I don't recognize assignment type ${e.type}`);this.variables.set(e.variableName,t)}evaluateConditional(e){if("IfNode"===e.type){if(this.evaluateExpressionOrLiteral(e.expression))return e.statement}else if("IfElseNode"===e.type||"ElseIfNode"===e.type){if(this.evaluateExpressionOrLiteral(e.expression))return e.statement;if(e.elseStatement)return this.evaluateConditional(e.elseStatement)}else if("ElseNode"===e.type)return e.statement;return null}evaluateExpressionOrLiteral(e){if(e instanceof g.Expression){if("UnaryMinusExpressionNode"===e.type)return-1*this.evaluateExpressionOrLiteral(e.expression);if("ArithmeticExpressionNode"===e.type)return this.evaluateExpressionOrLiteral(e.expression);if("ArithmeticExpressionAddNode"===e.type)return this.evaluateExpressionOrLiteral(e.expression1)+this.evaluateExpressionOrLiteral(e.expression2);if("ArithmeticExpressionMinusNode"===e.type)return this.evaluateExpressionOrLiteral(e.expression1)-this.evaluateExpressionOrLiteral(e.expression2);if("ArithmeticExpressionMultiplyNode"===e.type)return this.evaluateExpressionOrLiteral(e.expression1)*this.evaluateExpressionOrLiteral(e.expression2);if("ArithmeticExpressionDivideNode"===e.type)return this.evaluateExpressionOrLiteral(e.expression1)/this.evaluateExpressionOrLiteral(e.expression2);if("BooleanExpressionNode"===e.type)return this.evaluateExpressionOrLiteral(e.booleanExpression);if("NegatedBooleanExpressionNode"===e.type)return!this.evaluateExpressionOrLiteral(e.booleanExpression);if("BooleanOrExpressionNode"===e.type)return this.evaluateExpressionOrLiteral(e.expression1)||this.evaluateExpressionOrLiteral(e.expression2);if("BooleanAndExpressionNode"===e.type)return this.evaluateExpressionOrLiteral(e.expression1)&&this.evaluateExpressionOrLiteral(e.expression2);if("BooleanXorExpressionNode"===e.type)return!this.evaluateExpressionOrLiteral(e.expression1)!=!this.evaluateExpressionOrLiteral(e.expression2);if("EqualToExpressionNode"===e.type)return this.evaluateExpressionOrLiteral(e.expression1)===this.evaluateExpressionOrLiteral(e.expression2);if("NotEqualToExpressionNode"===e.type)return this.evaluateExpressionOrLiteral(e.expression1)!==this.evaluateExpressionOrLiteral(e.expression2);if("GreaterThanExpressionNode"===e.type)return this.evaluateExpressionOrLiteral(e.expression1)>this.evaluateExpressionOrLiteral(e.expression2);if("GreaterThanOrEqualToExpressionNode"===e.type)return this.evaluateExpressionOrLiteral(e.expression1)>=this.evaluateExpressionOrLiteral(e.expression2);if("LessThanExpressionNode"===e.type)return this.evaluateExpressionOrLiteral(e.expression1)<this.evaluateExpressionOrLiteral(e.expression2);if("LessThenOrEqualToExpressionNode"===e.type)return this.evaluateExpressionOrLiteral(e.expression1)<=this.evaluateExpressionOrLiteral(e.expression2);throw new Error(`I don't recognize expression type ${e.type}`)}if(e instanceof g.Literal){if("NumericLiteralNode"===e.type)return parseFloat(e.numericLiteral);if("StringLiteralNode"===e.type)return e.stringLiteral;if("BooleanLiteralNode"===e.type)return"true"===e.booleanLiteral;if("NullLiteralNode"===e.type)return null;if("VariableNode"===e.type)return this.variables.get(e.variableName);if("FunctionResultNode"===e.type){if(this.functions[e.functionName])return this.functions[e.functionName](e.args.map(this.evaluateExpressionOrLiteral));throw new Error(`Function "${e.functionName}" not found`)}throw new Error(`I don't recognize literal type ${e.type}`)}throw new Error(`I don't recognize expression/literal type ${e.type}`)}},TextResult:x.TextResult,CommandResult:x.CommandResult,OptionsResult:x.OptionsResult}}));